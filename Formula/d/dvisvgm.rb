class Dvisvgm < Formula
  desc "Fast DVI to SVG converter"
  homepage "https://dvisvgm.de"
  url "https://mirror.ghproxy.com/https://github.com/mgieseki/dvisvgm/releases/download/3.6/dvisvgm-3.6.tar.gz"
  sha256 "26446bb3b10739ff0925c9e416b76d2d222075c9d5dcfafe6e214609d072ed1a"
  license "GPL-3.0-or-later"

  bottle do
    rebuild 1
    sha256 cellar: :any,                 arm64_tahoe:   "4e4e50ff08bb77348f99e721bbc28da6b979642cf35b02a4ad3c77670dbb9206"
    sha256 cellar: :any,                 arm64_sequoia: "cd3025efcf127977c45a40c97f427a419ec71c8111914afdf9f61b20d7ebb255"
    sha256 cellar: :any,                 arm64_sonoma:  "32e7561006749b0e2c109b61007c7a487b6b0bdc5f1e58f40eb519117fca05f0"
    sha256 cellar: :any,                 sonoma:        "9c5c57dd7f7c9d78ce7364898fdc654f69ef139e1808ef3dbac83627fb33871e"
    sha256 cellar: :any_skip_relocation, arm64_linux:   "e4109e7ac608cb01d54f5cc3cd407f7b9808592deedd2276d95d642a7bed5574"
    sha256 cellar: :any_skip_relocation, x86_64_linux:  "8e5bf36eeba83828c796f3c32ec68ecb32a7fc81c9635e5ef4cc3d2788a7e1d4"
  end

  depends_on "autoconf" => :build
  depends_on "automake" => :build
  depends_on "libtool" => :build
  depends_on "pkgconf" => :build

  depends_on "brotli"
  depends_on "freetype"
  depends_on "ghostscript"
  depends_on "potrace"
  depends_on "texlive"
  depends_on "woff2"

  on_linux do
    depends_on "zlib-ng-compat"
  end

  def install
    args = [
      "--disable-silent-rules",
      "--with-texlive=#{Formula["texlive"].opt_prefix}",
    ]
    args << "--with-zlib=#{Formula["zlib-ng-compat"].opt_prefix}" if OS.linux?

    system "./configure", *args, *std_configure_args
    system "make"
    system "make", "install"

    pkgshare.install "tests/data/sample.dvi"
  end

  test do
    assert_match version.to_s, shell_output("#{bin}/dvisvgm --version")

    # Convert DVI to SVG
    system bin/"dvisvgm", "--no-fonts", pkgshare/"sample.dvi"
    assert_match "This file was generated by dvisvgm #{version}", (testpath/"sample.svg").read
  end
end
